import streamlit as st
import pandas as pd
import re

###########################################################
# –°–ò–ù–û–ù–ò–ú–´ –ò –ê–í–¢–û–ì–†–£–ü–ü–´
###########################################################
SYNONYMS = {
    "–º—É–∫–∞ –ø—à–µ–Ω–∏—á–Ω–∞—è": "–ø—à–µ–Ω–∏—á–Ω–∞—è –º—É–∫–∞",
    "–≤–∞–Ω–∏–ª—å –ø–æ –∂–µ–ª–∞–Ω–∏—é": "–≤–∞–Ω–∏–ª—å–Ω–∞—è –ø–∞—Å—Ç–∞",
    "–º–∏–∫—Å —Å—É—à—ë–Ω—ã—Ö —Ç—Ä–∞–≤": "–º–∏–∫—Å —Å—É—à—ë–Ω—ã—Ö —Ç—Ä–∞–≤",
}

AUTO_GROUPS = {
    "—Ç–≤–æ—Ä–æ–≥": "–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "—Å–ª–∏–≤–∫–∏": "–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "—Å—ã—Ä": "–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "—Å—É–ª—É–≥—É–Ω–∏": "–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "–º–æ–ª–æ–∫–æ": "–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "–º–∞—Å–ª–æ": "–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "—è–π—Ü": "—è–π—Ü–∞",       # ¬´—è–π—Ü–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è c1)¬ª => –≥—Ä—É–ø–ø–∞ ¬´—è–π—Ü–∞¬ª
    "–º—É–∫–∞": "–º—É–∫–∞ –∏ –∑–ª–∞–∫–∏",
    "–∫—Ä–∞—Ö–º–∞–ª": "–º—É–∫–∞ –∏ –∑–ª–∞–∫–∏",
    "—Ä–∞–∑—Ä—ã—Ö–ª–∏—Ç–µ–ª—å": "–º—É–∫–∞ –∏ –∑–ª–∞–∫–∏",
    "—É–∫—Ä–æ–ø": "–æ–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å",
    "—Å–æ–ª—å": "—Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã",
    "–ø–µ—Ä–µ—Ü": "—Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã",
    "–≤–∞–Ω–∏–ª—å": "—Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã",
    "–º–∞–∫": "—Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã",
    "—Å–∞—Ö–∞—Ä": "—Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã",
    "—Ñ—É–Ω–¥—É–∫": "–æ—Ä–µ—Ö–∏",
    "–º–∏–Ω–¥–∞–ª—å": "–æ—Ä–µ—Ö–∏",
    "–º–∏–∫—Å —Å—É—à—ë–Ω—ã—Ö —Ç—Ä–∞–≤": "—Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã",
    "–≤–∏—à": "—è–≥–æ–¥—ã",
    "—à–æ–∫–æ–ª–∞–¥": "–∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∏–µ –∏–∑–¥–µ–ª–∏—è",
    "–¥–ª—è –Ω–∞—á–∏–Ω–∫–∏": "",
}

###########################################################
# –ü–∞—Ä—Å–∏–Ω–≥ ¬´100 –≥¬ª -> (100, "–≥")
###########################################################
def parse_quantity(qty_str: str):
    match = re.match(r"(\d+)\s?(–≥|–≥—Ä|–º–ª|—à—Ç|kg|–ª|—Å—Ç\.–ª|—á\.–ª|—â–µ–ø–æ—Ç–∫–∞)", qty_str.strip(), re.IGNORECASE)
    if match:
        num = float(match.group(1))
        unit = match.group(2).lower()
        return (num, unit)
    return (0.0, "")

###########################################################
# –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
###########################################################
def unify_ingredient_name(original_name: str) -> str:
    """
    –ù–µ –≤—ã—Ä–µ–∑–∞–µ–º ¬´(–∫–∞—Ç–µ–≥–æ—Ä–∏—è c1)¬ª,
    —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å.
    """
    name = original_name.strip().lower()
    if name in SYNONYMS:
        name = SYNONYMS[name]
    return name.strip()

###########################################################
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∞
###########################################################
def auto_assign_group(ing_name: str) -> str:
    ing_lower = ing_name.lower()
    for key_sub, group_name in AUTO_GROUPS.items():
        if key_sub in ing_lower:
            return group_name
    return ""

###########################################################
# –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ CSV (3 -> 5 –∫–æ–ª–æ–Ω–æ–∫)
###########################################################
@st.cache_data
def load_and_parse(csv_path="recipes.csv"):
    df_old = pd.read_csv(csv_path)
    df_old.columns = df_old.columns.str.strip()

    needed_cols = {"–†–µ—Ü–µ–ø—Ç", "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã", "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"}
    missing = needed_cols - set(df_old.columns)
    if missing:
        st.error(f"–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–æ–ª–±—Ü—ã: {missing}")
        return pd.DataFrame()

    new_rows = []
    for _, row in df_old.iterrows():
        recipe_name = str(row["–†–µ—Ü–µ–ø—Ç"]).strip()
        instruction = str(row["–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"])
        ingredients_list = str(row["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã"]).split("\n")

        for ing in ingredients_list:
            ing_low = ing.lower().strip()
            if not ing_low or "–¥–ª—è –Ω–∞—á–∏–Ω–∫–∏" in ing_low:
                continue

            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
            qty_match = re.search(r"(\d+\s?(–≥|–≥—Ä|–º–ª|—à—Ç|kg|–ª|—Å—Ç\.–ª|—á\.–ª|—â–µ–ø–æ—Ç–∫–∞))", ing, re.IGNORECASE)
            quantity = qty_match.group(0) if qty_match else ""

            # –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ —Å–∫–æ–±–æ–∫
            group_match = re.search(r"\((.*?)\)", ing)
            group_str = group_match.group(1) if group_match else ""

            # –£–±–∏—Ä–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ —É–¥–∞–ª—è–µ–º (–∫–∞—Ç–µ–≥–æ—Ä–∏—è c1)...
            name_no_qty = re.sub(r"(\d+\s?(–≥|–≥—Ä|–º–ª|—à—Ç|kg|–ª|—Å—Ç\.–ª|—á\.–ª|—â–µ–ø–æ—Ç–∫–∞))", "", ing, flags=re.IGNORECASE)
            name_no_qty = re.sub(r"\s?[‚Äî-]{1,2}\s?$", "", name_no_qty)
            name_no_qty = re.sub(r"\s?\.\s?$", "", name_no_qty)
            name_no_qty = name_no_qty.strip()

            ing_clean = unify_ingredient_name(name_no_qty)

            # –ï—Å–ª–∏ group_str –ø—É—Å—Ç–æ -> auto_assign
            group_str = group_str.lower()
            if re.search(r"–∫–∞—Ç–µ–≥–æ—Ä–∏—è\s*c\d", group_str):
                group_str = "—è–π—Ü–∞"
            if not group_str:
                group_str = auto_assign_group(ing_clean)

            new_rows.append({
                "–†–µ—Ü–µ–ø—Ç": recipe_name,
                "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç": name_no_qty.strip(),
                "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ": quantity.strip(),
                "–ì—Ä—É–ø–ø–∞": group_str.strip(),
                "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è": instruction
            })

    return pd.DataFrame(new_rows)

###########################################################
# –°—É–º–º–∏—Ä—É–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—É—á–∏—Ç—ã–≤–∞—è ¬´–ü–æ—Ä—Ü–∏–∏¬ª –∫–∞–∫ –º–Ω–æ–∂–∏—Ç–µ–ª—å)
###########################################################
def sum_ingredients(cart_df: pd.DataFrame):
    # –ö–∞–∂–¥—ã–π —Ä–µ—Ü–µ–ø—Ç —Ö—Ä–∞–Ω–∏—Ç ¬´–ü–æ—Ä—Ü–∏–∏¬ª. –ü—Ä–∏ —É–º–Ω–æ–∂–µ–Ω–∏–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ = P–æ—Ä—Ü–∏–∏ * parse_quantity
    rows = []
    for _, row in cart_df.iterrows():
        # —É–º–Ω–æ–∂–∞–µ–º parse_quantity(qty_str) –Ω–∞ row["–ü–æ—Ä—Ü–∏–∏"]
        portions = row["–ü–æ—Ä—Ü–∏–∏"]
        orig_name = row["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"]
        grp = row["–ì—Ä—É–ø–ø–∞"]
        qty_str = row["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
        base_num, unit = parse_quantity(qty_str)
        num = base_num * portions  # –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ–ª-–≤–æ –ø–æ—Ä—Ü–∏–π
        rows.append({
            "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç": orig_name,
            "–ì—Ä—É–ø–ø–∞": grp,
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–∏—Å–ª–æ": num,
            "–ï–¥–∏–Ω–∏—Ü–∞": unit
        })
    tmp_df = pd.DataFrame(rows)
    grouped = tmp_df.groupby(["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç", "–ì—Ä—É–ø–ø–∞", "–ï–¥–∏–Ω–∏—Ü–∞"], as_index=False)["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–∏—Å–ª–æ"].sum()
    return grouped

###########################################################
def add_recipe_to_cart(recipe_name, portions, df_parsed):
    if "cart" not in st.session_state:
        st.session_state["cart"] = pd.DataFrame(
            columns=["–†–µ—Ü–µ–ø—Ç","–ü–æ—Ä—Ü–∏–∏","–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ","–ì—Ä—É–ø–ø–∞","–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"]
        )

    # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —ç—Ç–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
    selected_rows = df_parsed[df_parsed["–†–µ—Ü–µ–ø—Ç"] == recipe_name]
    if selected_rows.empty:
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ä–µ—Ü–µ–ø—Ç –≤ cart
    cart = st.session_state["cart"]
    existing_index = cart[cart["–†–µ—Ü–µ–ø—Ç"] == recipe_name].index

    if not existing_index.empty:
        # –£–∂–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç, —Ç–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏–º ¬´–ü–æ—Ä—Ü–∏–∏¬ª
        idx = existing_index[0]
        old_portions = cart.loc[idx, "–ü–æ—Ä—Ü–∏–∏"]
        new_portions = old_portions + portions
        st.session_state["cart"].loc[idx, "–ü–æ—Ä—Ü–∏–∏"] = new_portions
        st.success(f"–£ —Ä–µ—Ü–µ–ø—Ç–∞ ¬´{recipe_name}¬ª —Ç–µ–ø–µ—Ä—å {new_portions} –ø–æ—Ä—Ü–∏–π!")
    else:
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ—Ü–µ–ø—Ç–∞
        # –í –Ω–µ–π –Ω–∞–¥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å—É–º–º–∞—Ä–Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã? ‚Äî –ù–µ—Ç, —Å–∞–º–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤—Å–µ
        # –ù–æ –ø–æ –¢–ó: User –Ω–µ —Ö–æ—á–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å,
        # => –•—Ä–∞–Ω–∏–º —Ä–æ–≤–Ω–æ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É per –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç?
        # => –£–ø—Ä–æ—Å—Ç–∏–º: –•—Ä–∞–Ω–∏–º —Ä–æ–≤–Ω–æ 1 —Å—Ç—Ä–æ–∫—É PER —Ä–µ—Ü–µ–ø—Ç,
        #    –∞ —É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ parse_quantity * portions.
        # –ù–æ —Ç–æ–≥–¥–∞ –º—ã –ø–æ—Ç–µ—Ä—è–µ–º –¥–µ—Ç–∞–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤‚Ä¶

        # –ß—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å —Ä–æ–≤–Ω–æ 1 —Å—Ç—Ä–æ–∫—É, –ø—Ä–∏–¥—ë—Ç—Å—è ¬´—Å–ª–∏–≤–∞—Ç—å¬ª –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å.
        # –û–¥–Ω–∞–∫–æ —É–¥–æ–±–Ω–µ–µ —Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–æ—Å—Ç—Ä–æ—á–Ω–æ.
        # –†–∞–∑ –¢–ó –≥–ª–∞—Å–∏—Ç ¬´–£ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ—Ä—Ü–∏—è=1, –Ω–æ —Å—Ç—Ä–æ–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–µ –Ω–∞–¥–æ¬ª ‚Äî
        # –º—ã —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞ ‚Äî –û–î–ù–ê —Å—Ç—Ä–æ–∫–∞, '–ü–æ—Ä—Ü–∏–∏' = X, '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã' = ... ???

        # –û–¥–Ω–∞–∫–æ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ª–æ–≥–∏–∫–∞ –±—ã–ª–∞,
        # —á—Ç–æ df_parsed —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫ (–ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É).
        # –ï—Å–ª–∏ —Ö–æ—Ç–∏–º 1 —Å—Ç—Ä–æ–∫—É per —Ä–µ—Ü–µ–ø—Ç, –ø—Ä–∏–¥—ë—Ç—Å—è ¬´—Å–ª–∏–≤–∞—Ç—å¬ª –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã.

        # !!! –£–ø—Ä–æ—Å—Ç–∏–º: —Ö—Ä–∞–Ω–∏–º 1 —Å—Ç—Ä–æ–∫—É –Ω–∞ —Ä–µ—Ü–µ–ø—Ç,
        # => ingredients_list / quantity_list / group_list => ?

        # –ù–æ T–ó "–Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏" ‚Äî –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç,
        #   —á—Ç–æ cart –∏–º–µ–µ—Ç 1 —Å—Ç—Ä–æ–∫—É per —Ä–µ—Ü–µ–ø—Ç,
        #   –∞ –∏—Ç–æ–≥–æ–≤—ã–π parse –¥–µ–ª–∞–µ–º "–Ω–∞ –ª–µ—Ç—É"?
        # Ok, –¥–∞–≤–∞–π—Ç–µ.

        #  => –°–æ–ª—å—ë–º df_parsed –ø–æ —ç—Ç–æ–º—É —Ä–µ—Ü–µ–ø—Ç—É => JSON
        #  => '–ü–æ—Ä—Ü–∏–∏' = portions

        # –°–æ–ª—å—ë–º –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã / –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ / –≥—Ä—É–ø–ø—ã –≤ JSON –¥–ª—è 1 —Å—Ç—Ä–æ–∫–∏
        ing_json = selected_rows.to_dict(orient="records")
        # ing_json ‚Äî —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π (–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ì—Ä—É–ø–ø–∞, ...)
        # –•—Ä–∞–Ω–∏–º –æ–¥–Ω–∏–º —Å–ª–æ–≤–∞—Ä—ë–º
        row_data = {
            "–†–µ—Ü–µ–ø—Ç": recipe_name,
            "–ü–æ—Ä—Ü–∏–∏": portions,
            "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç": ing_json,  # —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ": "",        # –ø—É—Å—Ç–æ, —Ç.–∫. –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ—è
            "–ì—Ä—É–ø–ø–∞": "",            # –ø—É—Å—Ç–æ, —É –Ω–∞—Å —Ä–∞–∑–Ω–æ–µ
            "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è": selected_rows.iloc[0]["–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"]
        }
        st.session_state["cart"] = st.session_state["cart"].append(row_data, ignore_index=True)
        st.success(f"–î–æ–±–∞–≤–ª–µ–Ω —Ä–µ—Ü–µ–ø—Ç ¬´{recipe_name}¬ª x {portions} –ø–æ—Ä—Ü–∏–π!")

def remove_recipe_from_cart(recipe_name):
    if "cart" not in st.session_state:
        return
    st.session_state["cart"] = st.session_state["cart"][st.session_state["cart"]["–†–µ—Ü–µ–ø—Ç"] != recipe_name]

###########################################################
def main():
    st.title("–ö—É–ª–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ üç≥")

    df = load_and_parse("recipes.csv")
    if df.empty:
        return

    #=== –ü–æ–∏—Å–∫
    st.header("–ü–æ–∏—Å–∫ –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É")
    ing_search = st.text_input("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:")
    if ing_search:
        found = df[df["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"].str.contains(ing_search.lower(), case=False, na=False)]
        if not found.empty:
            st.subheader("–†–µ—Ü–µ–ø—Ç—ã —Å —ç—Ç–∏–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–º:")
            for rcp in found["–†–µ—Ü–µ–ø—Ç"].unique():
                st.markdown(f"- **{rcp}**")
        else:
            st.write("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ—Ü–µ–ø—Ç–æ–≤ —Å —Ç–∞–∫–∏–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–º.")
        st.write("---")

    #=== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    st.header("–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã –≤ —Å–ø–∏—Å–æ–∫ (—Å —É—á—ë—Ç–æ–º –ø–æ—Ä—Ü–∏–π)")
    rec_list = df["–†–µ—Ü–µ–ø—Ç"].unique().tolist()
    recipe_choice = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç:", [""] + rec_list)
    portions = st.number_input("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π:", min_value=1, max_value=50, value=1)

    if st.button("–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫"):
        if recipe_choice:
            add_recipe_to_cart(recipe_choice, portions, df)

    #=== –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤
    st.header("–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã (—Å–ø–∏—Å–æ–∫)")
    if "cart" not in st.session_state or st.session_state["cart"].empty:
        st.write("–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤.")
    else:
        cart_df = st.session_state["cart"].copy()

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ä–µ—Ü–µ–ø—Ç–∞, —Å—É–º–º–∏—Ä—É—è '–ü–æ—Ä—Ü–∏–∏'
        grouped_recipes = cart_df.groupby("–†–µ—Ü–µ–ø—Ç")["–ü–æ—Ä—Ü–∏–∏"].sum().reset_index()

        for _, rrow in grouped_recipes.iterrows():
            rcp_name = rrow["–†–µ—Ü–µ–ø—Ç"]
            total_port = rrow["–ü–æ—Ä—Ü–∏–∏"]
            st.markdown(f"- **{rcp_name}** (–≤—Å–µ–≥–æ –ø–æ—Ä—Ü–∏–π: {total_port})")
            if st.button(f"–£–¥–∞–ª–∏—Ç—å ¬´{rcp_name}¬ª"):
                remove_recipe_from_cart(rcp_name)
                st.success(f"¬´{rcp_name}¬ª —É–¥–∞–ª—ë–Ω!")
                return
        st.write("---")

        #=== –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–ø–æ –≥—Ä—É–ø–ø–∞–º)
        st.write("### –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–ø–æ –≥—Ä—É–ø–ø–∞–º)")
        # –ù—É–∂–Ω–æ ¬´–Ω–∞ –ª–µ—Ç—É¬ª —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ cart (JSON), —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ ¬´–ü–æ—Ä—Ü–∏–∏¬ª.
        rows = []
        for _, crow in cart_df.iterrows():
            recipe_name = crow["–†–µ—Ü–µ–ø—Ç"]
            portions = crow["–ü–æ—Ä—Ü–∏–∏"]
            ing_json = crow["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"]
            if isinstance(ing_json, list):
                # –≠—Ç–æ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
                for ing_entry in ing_json:
                    ing_name = ing_entry["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"]
                    grp = ing_entry["–ì—Ä—É–ø–ø–∞"]
                    qty_str = ing_entry["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
                    base, unit = parse_quantity(qty_str)
                    total = base * portions
                    rows.append({
                        "–†–µ—Ü–µ–ø—Ç": recipe_name,
                        "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç": ing_name,
                        "–ì—Ä—É–ø–ø–∞": grp,
                        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–∏—Å–ª–æ": total,
                        "–ï–¥–∏–Ω–∏—Ü–∞": unit
                    })
            else:
                # –∏–Ω–∞—á–µ –Ω–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
                pass
        if rows:
            final_df = pd.DataFrame(rows)
            grouped_final = final_df.groupby(["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ì—Ä—É–ø–ø–∞","–ï–¥–∏–Ω–∏—Ü–∞"], as_index=False)["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–∏—Å–ª–æ"].sum()
            # group by group
            group_cat = grouped_final.groupby("–ì—Ä—É–ø–ø–∞")
            for grp_name in sorted(group_cat.groups.keys()):
                sub = group_cat.get_group(grp_name)
                st.markdown(f"#### {grp_name if grp_name else '–ë–µ–∑ –≥—Ä—É–ø–ø—ã'}")
                for _, frow in sub.iterrows():
                    ing = frow["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"]
                    num = frow["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–∏—Å–ª–æ"]
                    unt = frow["–ï–¥–∏–Ω–∏—Ü–∞"]
                    if unt:
                        st.markdown(f"- **{ing}**: {num} {unt}")
                    else:
                        st.markdown(f"- **{ing}**: {num}")
        else:
            st.write("–ü–æ–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç.")
        st.write("---")

    #=== –í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã
    st.header("–í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã (–æ—Ä–∏–≥–∏–Ω–∞–ª)")
    grouped_df = df.groupby("–†–µ—Ü–µ–ø—Ç")
    for rname, group in grouped_df:
        st.markdown(f"## {rname}")
        st.markdown("**–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:**")
        for _, r_ing in group.iterrows():
            ing = r_ing["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"]
            qty = r_ing["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
            qpart = f" ‚Äî {qty}" if qty else ""
            st.markdown(f"- {ing}{qpart}")
        st.markdown(f"**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**\n{group.iloc[0]['–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è']}")
        st.write("---")

if __name__ == "__main__":
    main()
